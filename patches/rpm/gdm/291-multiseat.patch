From 5925a4052eaeab032be76cad3aa6d54f3a113892 Mon Sep 17 00:00:00 2001
From: Myrrh Periwinkle <myrrhperiwinkle@qtmlabs.xyz>
Date: Mon, 26 May 2025 09:48:11 +0700
Subject: [PATCH 1/4] daemon: Replace some seat0 checks with sd_seat_can_tty

Fixes code that checks for seat0 when we actually want to check if the
seat is VT-capable instead.
---
 daemon/gdm-local-display-factory.c | 2 +-
 daemon/gdm-session.c               | 3 ++-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/daemon/gdm-local-display-factory.c b/daemon/gdm-local-display-factory.c
index b350671c9..eae1edd9b 100644
--- a/daemon/gdm-local-display-factory.c
+++ b/daemon/gdm-local-display-factory.c
@@ -564,10 +564,7 @@ on_display_status_changed (GdmDisplay             *display,
                 if (is_local &&
                     ((g_strcmp0 (session_class, "greeter") != 0 &&
                       (!seat_active_session || g_strcmp0(session_id, seat_active_session) == 0)) ||
-#if defined(ENABLE_USER_DISPLAY_SERVER)
-                     (g_strcmp0 (seat_id, "seat0") == 0 && factory->active_vt == GDM_INITIAL_VT) ||
-#endif
-                     g_strcmp0 (seat_id, "seat0") != 0)) {
+                     factory->active_vt == GDM_INITIAL_VT || !sd_seat_can_tty (seat_id))) {
                         /* reset num failures */
                         factory->num_failures = 0;
 
diff --git a/daemon/gdm-session.c b/daemon/gdm-session.c
index 388b0d037..5eb34f5d7 100644
--- a/daemon/gdm-session.c
+++ b/daemon/gdm-session.c
@@ -3623,7 +3623,8 @@ gdm_session_get_display_mode (GdmSession *self)
                 return GDM_SESSION_DISPLAY_MODE_REUSE_VT;
         }
 
-        if (g_strcmp0 (self->display_seat_id, "seat0") != 0) {
+        if (self->display_seat_id != NULL &&
+            !sd_seat_can_tty (self->display_seat_id)) {
                 return GDM_SESSION_DISPLAY_MODE_LOGIND_MANAGED;
         }
 
-- 
GitLab


From 2012fc970ece406ab358dfe3d724fe450572d08c Mon Sep 17 00:00:00 2001
From: Myrrh Periwinkle <myrrhperiwinkle@qtmlabs.xyz>
Date: Sun, 25 May 2025 20:03:30 +0700
Subject: [PATCH 2/4] daemon: Reactivate greeter after opening non-VT user
 session

systemd-logind automatically activates newly created sessions on non-VT
seats. Switch back to the greeter session in that case so the greeter
can complete whatever is needed between opening and starting the
session, and switch to the actual session when we start it.
---
 daemon/gdm-manager.c | 28 ++++++++++++++++++++++++++--
 1 file changed, 26 insertions(+), 2 deletions(-)

diff --git a/daemon/gdm-manager.c b/daemon/gdm-manager.c
index a437aaac9..84d545686 100644
--- a/daemon/gdm-manager.c
+++ b/daemon/gdm-manager.c
@@ -1689,6 +1689,13 @@ on_start_user_session (StartUserSessionOperation *operation)
                 }
         }
 
+        if (gdm_session_get_display_mode (operation->session) == GDM_SESSION_DISPLAY_MODE_LOGIND_MANAGED) {
+                gdm_activate_session_by_id (operation->manager->connection,
+                                            NULL,
+                                            gdm_session_get_display_seat_id (operation->session),
+                                            session_id);
+        }
+
         start_user_session (operation->manager, operation);
 
  out:
@@ -1711,7 +1718,7 @@ queue_start_user_session (GdmManager *manager,
         g_object_set_data (G_OBJECT (session), "start-user-session-operation", operation);
 }
 
-static void
+static gboolean
 start_user_session_if_ready (GdmManager *manager,
                              GdmSession *session,
                              const char *service_name)
@@ -1725,6 +1732,8 @@ start_user_session_if_ready (GdmManager *manager,
         } else {
                 g_object_set_data (G_OBJECT (session), "waiting-to-start", GINT_TO_POINTER (TRUE));
         }
+
+        return start_when_ready;
 }
 
 static void
@@ -1766,6 +1775,8 @@ on_user_session_opened (GdmSession       *session,
                         const char       *session_id,
                         GdmManager       *manager)
 {
+        gboolean start_when_ready;
+
         manager->user_sessions = g_list_append (manager->user_sessions,
                                                       g_object_ref (session));
         if (g_strcmp0 (service_name, "gdm-autologin") == 0 &&
@@ -1775,7 +1786,20 @@ on_user_session_opened (GdmSession       *session,
                 g_object_set_data (G_OBJECT (session), "start-when-ready", GINT_TO_POINTER (TRUE));
         }
 
-        start_user_session_if_ready (manager, session, service_name);
+        start_when_ready = start_user_session_if_ready (manager, session, service_name);
+
+        if (!start_when_ready &&
+            gdm_session_get_display_mode (session) == GDM_SESSION_DISPLAY_MODE_LOGIND_MANAGED) {
+                /* systemd-logind automatically activates newly created sessions on seats
+                 * without VTs. Go back to greeter so it can run animations as well as prompt
+                 * for terminating conflicting sessions. */
+                GdmDisplay *display = get_display_for_user_session (session);
+
+                gdm_activate_session_by_id (manager->connection,
+                                            NULL,
+                                            gdm_session_get_display_seat_id (session),
+                                            gdm_display_get_session_id (display));
+        }
 }
 
 static void
-- 
GitLab


From 4ca1fbe55b15b6db2820ac4925dafb2ef1add38a Mon Sep 17 00:00:00 2001
From: Myrrh Periwinkle <myrrhperiwinkle@qtmlabs.xyz>
Date: Mon, 26 May 2025 08:57:30 +0700
Subject: [PATCH 3/4] daemon: Check for prepared display before creating
 non-seat0 display

Fixes an issue where duplicate greeter sessions are created when
multiple sessions on the same non-seat0 seat is terminated.

Checking for managed displays is not needed here since any managed
display should already be registered with systemd-logind and therefore
will be detected by gdm_get_login_window_session_id.
---
 daemon/gdm-local-display-factory.c | 25 +------------------------
 1 file changed, 1 insertion(+), 24 deletions(-)

diff --git a/daemon/gdm-local-display-factory.c b/daemon/gdm-local-display-factory.c
index eae1edd9b..88f85995e 100644
--- a/daemon/gdm-local-display-factory.c
+++ b/daemon/gdm-local-display-factory.c
@@ -646,21 +646,6 @@ lookup_prepared_display_by_seat_id (const char *id,
         return lookup_by_seat_id (id, display, user_data);
 }
 
-static gboolean
-lookup_managed_display_by_seat_id (const char *id,
-                                   GdmDisplay *display,
-                                   gpointer    user_data)
-{
-        int status;
-
-        status = gdm_display_get_status (display);
-
-        if (status != GDM_DISPLAY_MANAGED)
-                return FALSE;
-
-        return lookup_by_seat_id (id, display, user_data);
-}
-
 #ifdef HAVE_UDEV
 static gboolean
 udev_is_settled (GdmLocalDisplayFactory *factory)
@@ -772,19 +757,11 @@ GdmDisplay *
 get_display_for_seat (GdmLocalDisplayFactory *factory,
                       const char             *seat_id)
 {
-        GdmDisplay *display;
         GdmDisplayStore *store;
-        gboolean is_seat0;
 
         store = gdm_display_factory_get_display_store (GDM_DISPLAY_FACTORY (factory));
 
-        is_seat0 = g_strcmp0 (seat_id, "seat0") == 0;
-        if (is_seat0)
-                display = gdm_display_store_find (store, lookup_prepared_display_by_seat_id, (gpointer) seat_id);
-        else
-                display = gdm_display_store_find (store, lookup_managed_display_by_seat_id, (gpointer) seat_id);
-
-        return display;
+        return gdm_display_store_find (store, lookup_prepared_display_by_seat_id, (gpointer) seat_id);
 }
 
 static void
-- 
GitLab


From 2034855ff32b103bbbd12e1fe414d4e6a803e612 Mon Sep 17 00:00:00 2001
From: Myrrh Periwinkle <myrrhperiwinkle@qtmlabs.xyz>
Date: Mon, 26 May 2025 08:44:30 +0700
Subject: [PATCH 4/4] daemon: Don't switch to greeter if a background non-VT
 user session end

---
 daemon/gdm-local-display-factory.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/daemon/gdm-local-display-factory.c b/daemon/gdm-local-display-factory.c
index 88f85995e..d73d7aaf1 100644
--- a/daemon/gdm-local-display-factory.c
+++ b/daemon/gdm-local-display-factory.c
@@ -564,7 +564,8 @@ on_display_status_changed (GdmDisplay             *display,
                 if (is_local &&
                     ((g_strcmp0 (session_class, "greeter") != 0 &&
                       (!seat_active_session || g_strcmp0(session_id, seat_active_session) == 0)) ||
-                     factory->active_vt == GDM_INITIAL_VT || !sd_seat_can_tty (seat_id))) {
+                     (sd_seat_can_tty (seat_id) && factory->active_vt == GDM_INITIAL_VT) ||
+                     (!sd_seat_can_tty (seat_id) && g_strcmp0 (session_class, "greeter") == 0))) {
                         /* reset num failures */
                         factory->num_failures = 0;
 
-- 
GitLab

